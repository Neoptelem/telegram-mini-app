<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–õ–æ–≥–∏–∫–∞: –∫—Ä–∏—Å—Ç–∞–ª–ª –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ================== –û–ë–©–ò–ô –°–¢–ò–õ–¨ ================== */
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, #2020aa 0, #050563 45%, #020229 100%);
            color: #ffec9e;
        }

        .game-root {
            max-width: 960px;
            margin: 16px auto;
            padding: 12px 16px 24px;
            box-sizing: border-box;
        }

        /* ================== –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ================== */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: center;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .top-label {
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
        }

        .top-label .value {
            font-weight: 700;
            margin-left: 4px;
        }

        .crystals-strip {
            display: inline-flex;
            margin-left: 8px;
        }

        .crystal-icon {
            font-size: 20px;
            margin-left: 2px;
        }

        /* ================== –î–û–°–ö–ê –ò –í–•–û–î–´ ================== */
        .board {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .left-panel {
            width: 80px;
            padding-top: 32px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .input-switch {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            user-select: none;
        }

        .switch-cap {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: radial-gradient(circle at 30% 30%, #ffffff 0, #d8d8d8 40%, #888888 70%, #555555 100%);
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
            border: 2px solid #999999;
            transition: box-shadow 0.18s, border-color 0.18s, transform 0.06s;
        }

        .input-switch.on .switch-cap {
            border-color: #8cf28c;
            box-shadow: 0 0 12px rgba(120, 255, 120, 0.95);
            transform: translateY(-1px);
        }

        .switch-label {
            color: #ffffff;
            font-weight: 600;
            text-shadow: 0 0 4px #000000;
        }

        /* ================== –ü–û–õ–ï –õ–û–ì–ò–ö–ò –ò –ü–õ–ê–¢–§–û–†–ú ================== */
        .circuit-panel {
            flex: 1;
            background: rgba(0, 0, 80, 0.7);
            border-radius: 18px;
            padding: 12px 16px 24px;
            position: relative;
            box-shadow: 0 0 18px rgba(0, 0, 0, 0.65);
        }

        #rowsContainer {
            position: relative;
        }

        .circuit-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 14px 0;
        }

        /* –ü—Ä–æ–≤–æ–¥–∞ */
        .wire {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: repeating-linear-gradient(
                    90deg,
                    #ffffff 0,
                    #ffffff 6px,
                    #1aff5f 6px,
                    #1aff5f 12px
            );
            opacity: 0.25;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
        }

        .wire.energized {
            opacity: 1;
            animation: wire-flow 0.6s linear infinite;
        }

        @keyframes wire-flow {
            from {
                background-position-x: 0;
            }
            to {
                background-position-x: 24px;
            }
        }

        /* –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ */
        .gate {
            min-width: 80px;
            padding: 4px 6px;
            border-radius: 8px;
            background: linear-gradient(#ffe66b, #ffce45);
            color: #222222;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
            border: 1px solid #caa52a;
        }

        /* –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã */
        .platform {
            width: 150px;
        }

        .platform-track {
            position: relative;
            width: 100%;
            height: 18px;
            border-radius: 10px;
            background: linear-gradient(90deg, #707070, #bfbfbf);
            box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.9);
            overflow: hidden;
        }

        .platform-slider {
            position: absolute;
            right: -100px;
            top: 0;
            width: 100px;
            height: 18px;
            border-radius: 10px;
            background: linear-gradient(90deg, #d3d4db, #ff6666);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.85);
            transition: right 0.35s ease-out;
        }

        .platform.extended .platform-slider {
            right: 0;
        }

        .platform.retracted .platform-slider {
            right: -100px;
        }

        /* –ö—Ä–∏—Å—Ç–∞–ª–ª */
        .crystal {
            position: absolute;
            width: 26px;
            height: 26px;
            left: calc(100% - 32px);
            top: 0;
            transform: translateY(-50%);
            background: radial-gradient(circle at 30% 30%, #ffffff 0, #aaf7ff 40%, #00a9ff 70%, #004c92 100%);
            clip-path: polygon(50% 0%, 90% 35%, 70% 100%, 30% 100%, 10% 35%);
            box-shadow: 0 0 14px rgba(0, 255, 255, 0.9);
            transition: top 0.6s ease-in;
            pointer-events: none;
        }

        .crystal.crash {
            box-shadow: 0 0 14px rgba(255, 80, 80, 0.95);
            filter: hue-rotate(-40deg);
        }

        /* ================== –ö–ù–û–ü–ö–ò –ò –ü–û–î–ü–ò–°–ò ================== */
        .bottom-bar {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .bottom-bar button {
            flex: 0 0 auto;
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.7);
            background: linear-gradient(#ffdd77, #ffb433);
            color: #222;
            text-transform: uppercase;
        }

        .bottom-bar button.secondary {
            background: linear-gradient(#9ca3af, #6b7280);
            color: #111827;
        }

        .bottom-bar button:disabled {
            opacity: 0.55;
            cursor: default;
            box-shadow: none;
        }

        .hint {
            margin-top: 8px;
            font-size: 13px;
            color: #f1f5f9;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
        }

        @media (max-width: 720px) {
            .board {
                flex-direction: column;
            }
            .left-panel {
                flex-direction: row;
                width: auto;
                padding-top: 8px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="game-root">
    <!-- –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: —É—Ä–æ–≤–µ–Ω—å, —Å—á—ë—Ç, –∂–∏–∑–Ω–∏ -->
    <div class="top-bar">
        <div class="top-label">
            –£—Ä–æ–≤–µ–Ω—å <span class="value" id="levelNumber">1</span>
        </div>
        <div class="top-label">
            –°—á—ë—Ç <span class="value" id="scoreValue">1000</span>
        </div>
        <div class="top-label">
            –ö—Ä–∏—Å—Ç–∞–ª–ª—ã
            <span class="crystals-strip" id="crystals"></span>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ: –≤—Ö–æ–¥—ã –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ª–∏–Ω–∏–∏ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ -->
    <div class="board">
        <div class="left-panel">
            <div class="input-switch" data-input="A">
                <div class="switch-cap"></div>
                <div class="switch-label">A</div>
            </div>
            <div class="input-switch" data-input="B">
                <div class="switch-cap"></div>
                <div class="switch-label">B</div>
            </div>
            <div class="input-switch" data-input="C">
                <div class="switch-cap"></div>
                <div class="switch-label">C</div>
            </div>
            <div class="input-switch" data-input="D">
                <div class="switch-cap"></div>
                <div class="switch-label">D</div>
            </div>
        </div>

        <div class="circuit-panel" id="circuitPanel">
            <div id="rowsContainer"></div>
            <div id="crystal" class="crystal"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button id="runButton">–ü–æ–¥–∞—Ç—å —Ç–æ–∫</button>
        <button id="resetButton" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>
    </div>
    <div class="hint" id="hintText">
        –ù–∞—Å—Ç—Ä–æ–π –≤—Ö–æ–¥—ã A, B, C, D —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–æ–¥–∞—á–µ —Ç–æ–∫–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª –ø–∞–¥–∞–ª —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É. –ï—Å–ª–∏ –æ–Ω
        –ø—Ä–æ–ª–µ—Ç–∏—Ç –º–∏–º–æ —Å–æ—Å–µ–¥–Ω–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏–ª–∏ –Ω–µ –ø–æ–π–º–∞–µ—Ç—Å—è ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è.
    </div>
</div>

<!-- Telegram WebApp SDK (–ø–æ –∂–µ–ª–∞–Ω–∏—é –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
    // ================== –û–ü–ò–°–ê–ù–ò–ï –£–†–û–í–ù–ï–ô ==================
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –∑–∞–¥–∞—ë–º –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è 4 –ø–ª–∞—Ç—Ñ–æ—Ä–º.
    // row.compute –ø–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç –≤–∏–¥–∞ {A: true/false, B: ..., C: ..., D: ...}
    const LEVELS = [
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 1",
            hint: "–ü—Ä–æ—Å—Ç–µ–π—à–∏–µ –≤—Ö–æ–¥—ã A –∏ B. –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö, —á—Ç–æ–±—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏ —Å–¥–≤–∏–≥–∞—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.",
            rows: [
                {label: "A", compute: s => s.A},
                {label: "–ù–ï A", compute: s => !s.A},
                {label: "B", compute: s => s.B},
                {label: "–ù–ï B", compute: s => !s.B}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 2",
            hint: "–ò—Å–ø–æ–ª—å–∑—É–µ–º –ò –∏ –ò–õ–ò –¥–ª—è –¥–≤—É—Ö –≤—Ö–æ–¥–æ–≤.",
            rows: [
                {label: "A –ò B", compute: s => s.A && s.B},
                {label: "–ù–ï (A –ò B)", compute: s => !(s.A && s.B)},
                {label: "A –ò–õ–ò B", compute: s => s.A || s.B},
                {label: "–ù–ï (A –ò–õ–ò B)", compute: s => !(s.A || s.B)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 3",
            hint: "–í–≤–æ–¥–∏–º —Ç—Ä–µ—Ç–∏–π –≤—Ö–æ–¥ C. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∏–≥—Ä–∞—Ç—å —Å –ù–ï.",
            rows: [
                {label: "A –ò –ù–ï B", compute: s => s.A && !s.B},
                {label: "–ù–ï (A –ò –ù–ï B)", compute: s => !(s.A && !s.B)},
                {label: "C", compute: s => s.C},
                {label: "–ù–ï C", compute: s => !s.C}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 4",
            hint: "–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ A, B –∏ C —Å –ò –∏ –ò–õ–ò.",
            rows: [
                {label: "A –ò–õ–ò C", compute: s => s.A || s.C},
                {label: "–ù–ï (A –ò–õ–ò C)", compute: s => !(s.A || s.C)},
                {label: "B –ò C", compute: s => s.B && s.C},
                {label: "–ù–ï (B –ò C)", compute: s => !(s.B && s.C)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 5",
            hint: "–ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ä–∞–∑—É —á–µ—Ç—ã—Ä–µ –≤—Ö–æ–¥–∞.",
            rows: [
                {label: "A –ò B", compute: s => s.A && s.B},
                {label: "–ù–ï (A –ò B)", compute: s => !(s.A && s.B)},
                {label: "C –ò D", compute: s => s.C && s.D},
                {label: "–ù–ï (C –ò D)", compute: s => !(s.C && s.D)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 6",
            hint: "–ò–≥—Ä–∞–µ–º —Å –∏—Å–∫–ª—é—á–∞—é—â–∏–º –ò–õ–ò –¥–ª—è A –∏ B.",
            rows: [
                {
                    label: "A XOR B",
                    compute: s => (s.A && !s.B) || (!s.A && s.B)
                },
                {
                    label: "–ù–ï (A XOR B)",
                    compute: s => !((s.A && !s.B) || (!s.A && s.B))
                },
                {label: "C", compute: s => s.C},
                {label: "–ù–ï C", compute: s => !s.C}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 7",
            hint: "–°–æ–≤–º–µ—â–∞–µ–º –ù–ï –∏ –ò–õ–ò —Å —á–µ—Ç—ã—Ä—å–º—è –≤—Ö–æ–¥–∞–º–∏.",
            rows: [
                {label: "A –ò –ù–ï C", compute: s => s.A && !s.C},
                {label: "–ù–ï (A –ò –ù–ï C)", compute: s => !(s.A && !s.C)},
                {label: "B –ò–õ–ò D", compute: s => s.B || s.D},
                {label: "–ù–ï (B –ò–õ–ò D)", compute: s => !(s.B || s.D)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 8",
            hint: "–ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∏—Ç—å—Å—è –Ω—É–∂–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏–∑ !A –∏ B, C –∏ D.",
            rows: [
                {label: "–ù–ï A –ò B", compute: s => !s.A && s.B},
                {label: "–ù–ï (–ù–ï A –ò B)", compute: s => !(!s.A && s.B)},
                {label: "C –ò–õ–ò D", compute: s => s.C || s.D},
                {label: "–ù–ï (C –ò–õ–ò D)", compute: s => !(s.C || s.D)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 9",
            hint: "–°—Ä–∞–∑—É —Ç—Ä–∏ –≤—Ö–æ–¥–∞ –≤ –ò –∏ –µ—â—ë –æ–¥–∏–Ω —á–µ—Ä–µ–∑ –ò–õ–ò.",
            rows: [
                {label: "A –ò B –ò C", compute: s => s.A && s.B && s.C},
                {label: "–ù–ï (A –ò B –ò C)", compute: s => !(s.A && s.B && s.C)},
                {label: "B –ò–õ–ò D", compute: s => s.B || s.D},
                {label: "–ù–ï (B –ò–õ–ò D)", compute: s => !(s.B || s.D)}
            ]
        },
        {
            name: "–£—Ä–æ–≤–µ–Ω—å 10",
            hint: "–§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏.",
            rows: [
                {label: "A –ò –ù–ï B –ò C", compute: s => s.A && !s.B && s.C},
                {label: "–ù–ï (A –ò –ù–ï B –ò C)", compute: s => !(s.A && !s.B && s.C)},
                {
                    label: "(C –ò–õ–ò D) –ò –ù–ï A",
                    compute: s => (s.C || s.D) && !s.A
                },
                {
                    label: "–ù–ï((C –ò–õ–ò D) –ò –ù–ï A)",
                    compute: s => !((s.C || s.D) && !s.A)
                }
            ]
        }
    ];

    // ================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ==================
    let levelIndex = 0;
    let lives = 4;
    let score = 1000;
    let scoreTimer = null;
    let currentRow = 0;
    let isAnimating = false;

    const inputState = {A: false, B: false, C: false, D: false};

    let levelNumberEl, scoreValueEl, crystalsEl, hintTextEl;
    let runBtn, resetBtn, circuitPanel, rowsContainer, crystalEl;

    document.addEventListener("DOMContentLoaded", () => {
        levelNumberEl = document.getElementById("levelNumber");
        scoreValueEl = document.getElementById("scoreValue");
        crystalsEl = document.getElementById("crystals");
        hintTextEl = document.getElementById("hintText");
        runBtn = document.getElementById("runButton");
        resetBtn = document.getElementById("resetButton");
        circuitPanel = document.getElementById("circuitPanel");
        rowsContainer = document.getElementById("rowsContainer");
        crystalEl = document.getElementById("crystal");

        setupSwitches();

        runBtn.addEventListener("click", () => {
            if (isAnimating) return;
            const level = LEVELS[levelIndex];
            const states = level.rows.map(row => !!row.compute(inputState));
            animateWiresAndPlatforms(states);
        });

        resetBtn.addEventListener("click", () => {
            stopScoreTimer();
            runBtn.disabled = false;
            startGame();
        });

        startGame();

        // –ï—Å–ª–∏ –∏–≥—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–∞–∫ Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
        }
    });

    // ================== –ù–ê–°–¢–†–û–ô–ö–ê –í–•–û–î–û–í ==================
    function setupSwitches() {
        const switches = document.querySelectorAll(".input-switch");
        switches.forEach(sw => {
            const name = sw.dataset.input;
            sw.addEventListener("click", () => {
                inputState[name] = !inputState[name];
                sw.classList.toggle("on", inputState[name]);
            });
        });
    }

    function resetInputs() {
        for (const k of Object.keys(inputState)) {
            inputState[k] = false;
        }
        document.querySelectorAll(".input-switch").forEach(sw => {
            sw.classList.remove("on");
        });
    }

    // ================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–†–û–í–ù–Ø–ú–ò –ò –°–ß–Å–¢–û–ú ==================
    function startGame() {
        lives = 4;
        levelIndex = 0;
        loadLevel(levelIndex);
    }

    function loadLevel(idx) {
        const level = LEVELS[idx];
        currentRow = 0;
        resetInputs();
        renderRowsForLevel(level);
        updateUI();
        startScoreTimer();
        // –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª –Ω–∞ –≤–µ—Ä—Ö–Ω—é—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        setTimeout(() => {
            positionCrystalAtRow(0, true);
        }, 0);
    }

    function startScoreTimer() {
        if (scoreTimer) clearInterval(scoreTimer);
        score = 1000;
        updateScore();
        scoreTimer = setInterval(() => {
            if (score > 0) {
                score -= 1;
                updateScore();
            }
        }, 1000);
    }

    function stopScoreTimer() {
        if (scoreTimer) {
            clearInterval(scoreTimer);
            scoreTimer = null;
        }
    }

    function updateScore() {
        scoreValueEl.textContent = score.toString();
    }

    function updateUI() {
        levelNumberEl.textContent = (levelIndex + 1).toString();
        hintTextEl.textContent = LEVELS[levelIndex].hint;
        renderCrystals();
        updateScore();
    }

    function renderCrystals() {
        const maxLives = 4;
        crystalsEl.innerHTML = "";
        for (let i = 0; i < maxLives; i++) {
            const span = document.createElement("span");
            span.className = "crystal-icon";
            span.textContent = i < lives ? "üíé" : "‚óá";
            crystalsEl.appendChild(span);
        }
    }

    // ================== –û–¢–†–ò–°–û–í–ö–ê –°–¢–†–û–ö –ò –ü–û–ó–ò–¶–ò–Ø –ö–†–ò–°–¢–ê–õ–õ–ê ==================
    function renderRowsForLevel(level) {
        rowsContainer.innerHTML = "";
        level.rows.forEach((row, index) => {
            const rowEl = document.createElement("div");
            rowEl.className = "circuit-row";
            rowEl.dataset.row = index.toString();

            const wire = document.createElement("div");
            wire.className = "wire";

            const gate = document.createElement("div");
            gate.className = "gate";
            gate.textContent = row.label;

            const platform = document.createElement("div");
            platform.className = "platform retracted";
            platform.dataset.row = index.toString();

            const track = document.createElement("div");
            track.className = "platform-track";

            const slider = document.createElement("div");
            slider.className = "platform-slider";

            track.appendChild(slider);
            platform.appendChild(track);

            rowEl.appendChild(wire);
            rowEl.appendChild(gate);
            rowEl.appendChild(platform);

            rowsContainer.appendChild(rowEl);
        });
    }

    function getRowCenter(rowIndex) {
        const rowEl = rowsContainer.querySelector(`.circuit-row[data-row="${rowIndex}"]`);
        if (!rowEl) return 0;
        const panelRect = circuitPanel.getBoundingClientRect();
        const rowRect = rowEl.getBoundingClientRect();
        return rowRect.top - panelRect.top + rowRect.height / 2;
    }

    function getGroundY() {
        const panelRect = circuitPanel.getBoundingClientRect();
        return panelRect.height + 24;
    }

    function positionCrystalAtRow(rowIndex, immediate) {
        const top = getRowCenter(rowIndex);
        if (immediate) {
            crystalEl.style.transition = "none";
            crystalEl.style.top = top + "px";
            // force reflow
            void crystalEl.offsetHeight;
            crystalEl.style.transition = "top 0.6s ease-in";
        } else {
            crystalEl.style.top = top + "px";
        }
    }

    // ================== –ê–ù–ò–ú–ê–¶–ò–Ø –¢–û–ö–ê –ò –ü–õ–ê–¢–§–û–†–ú ==================
    function animateWiresAndPlatforms(states) {
        const rows = rowsContainer.querySelectorAll(".circuit-row");
        const delayPerRow = 200;
        const wireActiveTime = 350;
        isAnimating = true;

        rows.forEach((rowEl, idx) => {
            const wire = rowEl.querySelector(".wire");
            const platform = rowEl.querySelector(".platform");
            const isOn = states[idx];
            const start = idx * delayPerRow;

            setTimeout(() => {
                wire.classList.add("energized");
            }, start);

            setTimeout(() => {
                wire.classList.remove("energized");
                platform.classList.toggle("extended", isOn);
                platform.classList.toggle("retracted", !isOn);
            }, start + wireActiveTime);
        });

        const totalDelay = rows.length * delayPerRow + wireActiveTime + 60;
        setTimeout(() => {
            resolveCrystal(states, () => {
                isAnimating = false;
            });
        }, totalDelay);
    }

    // ================== –ü–ê–î–ï–ù–ò–ï –ö–†–ò–°–¢–ê–õ–õ–ê ==================
    function resolveCrystal(states, done) {
        const level = LEVELS[levelIndex];
        const rowsCount = level.rows.length;
        const r = currentRow;

        // –ï—Å–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–¥ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–º –æ—Å—Ç–∞—ë—Ç—Å—è –≤—ã–¥–≤–∏–Ω—É—Ç–æ–π ‚Äî –æ–Ω –Ω–µ –ø–∞–¥–∞–µ—Ç
        if (states[r]) {
            done();
            return;
        }

        const nextIndex = r + 1;
        let firstOn = -1;
        for (let i = nextIndex; i < rowsCount; i++) {
            if (states[i]) {
                firstOn = i;
                break;
            }
        }

        if (firstOn === nextIndex) {
            const isLast = (firstOn === rowsCount - 1);
            animateCrystalFallToRow(firstOn, isLast ? "win" : "safe", () => {
                currentRow = firstOn;
                done();
            });
        } else {
            const targetRow = (firstOn !== -1 ? firstOn : null);
            animateCrystalFallToRow(targetRow, "crash", () => {
                handleCrash();
                done();
            });
        }
    }

    function animateCrystalFallToRow(targetRowIndex, outcome, callback) {
        let targetTop;
        if (targetRowIndex === null) {
            targetTop = getGroundY();
        } else {
            targetTop = getRowCenter(targetRowIndex);
        }

        if (outcome === "crash") {
            crystalEl.classList.add("crash");
        } else {
            crystalEl.classList.remove("crash");
        }

        crystalEl.style.top = targetTop + "px";

        const duration = 650;
        setTimeout(() => {
            if (outcome === "win") {
                handleLevelCompleted();
            }
            if (outcome !== "crash") {
                crystalEl.classList.remove("crash");
            }
            callback();
        }, duration);
    }

    // ================== –†–ï–ó–£–õ–¨–¢–ê–¢–´: –ü–†–û–ò–ì–†–´–® / –ü–û–ë–ï–î–ê ==================
    function handleCrash() {
        lives -= 1;
        if (lives < 0) lives = 0;
        renderCrystals();

        if (lives <= 0) {
            stopScoreTimer();
            runBtn.disabled = true;
            hintTextEl.textContent = "–ö—Ä–∏—Å—Ç–∞–ª–ª —Ä–∞–∑–±–∏–ª—Å—è, –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.";
        } else {
            hintTextEl.textContent = "–ö—Ä–∏—Å—Ç–∞–ª–ª —Ä–∞–∑–±–∏–ª—Å—è! –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –≤—Ö–æ–¥–æ–≤ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ.";
            setTimeout(() => {
                loadLevel(levelIndex);
            }, 700);
        }
    }

    function handleLevelCompleted() {
        stopScoreTimer();
        hintTextEl.textContent = "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω! –ö—Ä–∏—Å—Ç–∞–ª–ª –ø—Ä–æ—à—ë–ª –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.";
        if (levelIndex < LEVELS.length - 1) {
            levelIndex += 1;
            setTimeout(() => {
                loadLevel(levelIndex);
            }, 900);
        } else {
            runBtn.disabled = true;
            hintTextEl.textContent = "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢—ã –ø—Ä–æ—à—ë–ª –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∏–≥—Ä—ã ¬´–õ–æ–≥–∏–∫–∞¬ª.";
        }
    }
</script>
</body>
</html>
